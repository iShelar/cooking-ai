#!/usr/bin/env node
/**
 * Generates public/firebase-messaging-sw.js from Firebase env vars.
 * Run before build: node scripts/generate-firebase-messaging-sw.mjs
 * Reads .env and .env.local (VITE_FIREBASE_*).
 */
import { readFileSync, writeFileSync, existsSync } from 'fs';
import { fileURLToPath } from 'url';
import path from 'path';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const root = path.resolve(__dirname, '..');

function loadEnv(file) {
  const p = path.join(root, file);
  if (!existsSync(p)) return {};
  const content = readFileSync(p, 'utf8');
  const out = {};
  for (const line of content.split('\n')) {
    const m = line.match(/^\s*VITE_FIREBASE_(\w+)\s*=\s*["']?([^"'\n#]*)["']?/);
    if (m) out[m[1]] = m[2].trim();
  }
  return out;
}

const env = { ...loadEnv('.env'), ...loadEnv('.env.local') };
const get = (key) => env[key] || (typeof process !== 'undefined' && process.env && process.env['VITE_FIREBASE_' + key]) || '';
const apiKey = get('API_KEY');
const authDomain = get('AUTH_DOMAIN');
const projectId = get('PROJECT_ID');
const storageBucket = get('STORAGE_BUCKET');
const messagingSenderId = get('MESSAGING_SENDER_ID');
const appId = get('APP_ID');

const swContent = `// Generated by scripts/generate-firebase-messaging-sw.mjs - do not edit by hand
// Service worker for FCM background push (meal/suggestion notifications)
importScripts('https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js');
importScripts('https://www.gstatic.com/firebasejs/10.14.0/firebase-messaging-compat.js');

firebase.initializeApp({
  apiKey: "${apiKey}",
  authDomain: "${authDomain}",
  projectId: "${projectId}",
  storageBucket: "${storageBucket}",
  messagingSenderId: "${messagingSenderId}",
  appId: "${appId}",
});

firebase.messaging().onBackgroundMessage(function(payload) {
  var title = (payload.notification && payload.notification.title) ? payload.notification.title : 'Pakao';
  var options = {
    body: (payload.notification && payload.notification.body) ? payload.notification.body : '',
    icon: '/pwa-192x192.png',
    data: payload.data || {},
  };
  return self.registration.showNotification(title, options);
});

self.addEventListener('notificationclick', function(event) {
  event.notification.close();
  var path = (event.notification.data && event.notification.data.url) || '/';
  var url = path.indexOf('http') === 0 ? path : (self.location.origin + (path.indexOf('/') === 0 ? path : '/' + path));
  event.waitUntil(
    clients.matchAll({ type: 'window', includeUncontrolled: true }).then(function(clientList) {
      for (var i = 0; i < clientList.length; i++) {
        var client = clientList[i];
        if (client.url.indexOf(self.location.origin) === 0 && 'navigate' in client) {
          client.navigate(url);
          return client.focus();
        }
      }
      if (clients.openWindow) return clients.openWindow(url);
    })
  );
});
`;

const outPath = path.join(root, 'public', 'firebase-messaging-sw.js');
writeFileSync(outPath, swContent, 'utf8');
console.log('Wrote public/firebase-messaging-sw.js');
